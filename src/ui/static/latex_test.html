<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaTeX + Markdown æµ‹è¯•é¡µé¢</title>

    <!-- å¤åˆ¶chat.htmlä¸­çš„MathJaxé…ç½® -->
    <script type="text/javascript">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'newcommand', 'configmacros']},
                tags: 'ams',
                tagSide: 'right',
                tagIndent: '.8em',
                multlineWidth: '85%',
                autoload: {
                    color: [],
                    colorV2: ['color']
                }
            },
            chtml: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false,
                fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
            },
            svg: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false,
                fontCache: 'global'
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            startup: {
                ready: function () {
                    MathJax.startup.defaultReady();
                    console.log('âœ“ MathJax å·²åˆå§‹åŒ–');
                }
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <!-- Markdown æ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .rendered-content {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
        }
        button:hover {
            background: #0056b3;
        }
        .mjx-container {
            display: inline-block !important;
            margin: 0 0.25em !important;
            vertical-align: middle !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .mjx-container[display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 0.5em 0 !important;
        }
    </style>
</head>
<body>
    <h1>LaTeX + Markdown åŒæ—¶æ¸²æŸ“æµ‹è¯•</h1>

    <div class="test-section">
        <h3>æµ‹è¯•1: ç›´æ¥LaTeXå…¬å¼</h3>
        <p>è¡Œå†…å…¬å¼: $E=mc^2$</p>
        <p>å—çº§å…¬å¼: $$\frac{a}{b} = \frac{c}{d}$$</p>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•2: Markdown + LaTeX æ··åˆå†…å®¹</h3>
        <textarea id="input" rows="8" style="width: 100%; font-family: monospace;">## è¿™æ˜¯æ ‡é¢˜

è¿™æ˜¯**ç²—ä½“**æ–‡æœ¬ï¼ŒåŒ…å«è¡Œå†…å…¬å¼ $E=mc^2$ å’Œ*æ–œä½“*æ–‡æœ¬ã€‚

ä¸‹é¢æ˜¯å—çº§å…¬å¼ï¼š
$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$

æœ€åæ˜¯`ä»£ç `å’Œå¦ä¸€ä¸ªå…¬å¼ $\sin^2(x) + \cos^2(x) = 1$
        </textarea>
        <br>
        <button onclick="testRender()">æµ‹è¯•æ¸²æŸ“</button>
        <button onclick="clearResult()">æ¸…ç©ºç»“æœ</button>

        <div class="rendered-content tex2jax_process" id="result">
            ç‚¹å‡»"æµ‹è¯•æ¸²æŸ“"æŒ‰é’®æŸ¥çœ‹ç»“æœ
        </div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•3: è¯Šæ–­ä¿¡æ¯</h3>
        <button onclick="checkMathJax()">æ£€æŸ¥ MathJax çŠ¶æ€</button>
        <button onclick="forceRender()">å¼ºåˆ¶é‡æ–°æ¸²æŸ“</button>
        <div id="diagnostics" style="background: #f0f0f0; padding: 1rem; margin-top: 1rem; font-family: monospace; font-size: 0.9rem;">
            è¯Šæ–­ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º
        </div>
    </div>

    <script>
        // å¤åˆ¶chat.jsä¸­çš„renderMarkdownæ–¹æ³•
        function renderMarkdown(content) {
            if (typeof content !== 'string') {
                console.warn('âš ï¸ å†…å®¹ä¸æ˜¯å­—ç¬¦ä¸²:', typeof content);
                return content;
            }

            const hasLatex = /\$\$[\s\S]*?\$\$|\$[^\$\n]+?\$|\\\([\s\S]*?\\\)|\\\[[\s\S]*?\\\]/.test(content);

            console.log(`ğŸ“ renderMarkdown è¾“å…¥åˆ†æ:`, {
                contentLength: content.length,
                hasLatex: hasLatex,
                preview: content.substring(0, 100)
            });

            if (typeof marked !== 'undefined') {
                try {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false,
                        headerIds: false,
                        mangle: false
                    });

                    // LaTeXä¿æŠ¤æœºåˆ¶
                    let processedContent = content;
                    const latexBlocks = [];
                    const latexInline = [];

                    if (hasLatex) {
                        console.log(`ğŸ“ å¼€å§‹å¤„ç†Markdownï¼Œæ£€æµ‹åˆ°LaTeX: ${hasLatex}`);

                        // Step 1: æå–å—çº§å…¬å¼ $$...$$ (å¿…é¡»åœ¨è¡Œå†…å…¬å¼ä¹‹å‰)
                        processedContent = processedContent.replace(/\$\$[\s\S]*?\$\$/g, (match) => {
                            const placeholder = `__LATEX_BLOCK_${latexBlocks.length}__`;
                            latexBlocks.push(match);
                            console.log(`ğŸ”’ ä¿æŠ¤å—çº§å…¬å¼: ${match.substring(0, 40)}... â†’ ${placeholder}`);
                            return placeholder;
                        });

                        // Step 2: æå–è¡Œå†…å…¬å¼ $...$ (ä½†è¦é¿å… $$)
                        processedContent = processedContent.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (match) => {
                            const placeholder = `__LATEX_INLINE_${latexInline.length}__`;
                            latexInline.push(match);
                            console.log(`ğŸ”’ ä¿æŠ¤è¡Œå†…å…¬å¼: ${match.substring(0, 40)}... â†’ ${placeholder}`);
                            return placeholder;
                        });

                        console.log(`âœ“ æå–å®Œæˆ: ${latexBlocks.length} ä¸ªå—çº§ + ${latexInline.length} ä¸ªè¡Œå†…`);
                    }

                    // Step 3: æ¸²æŸ“ Markdown
                    let rendered = marked.parse(processedContent);
                    console.log(`âœ“ Markdownæ¸²æŸ“å®Œæˆï¼Œè¾“å‡ºé•¿åº¦: ${rendered.length}`);

                    // Step 4: æ¢å¤LaTeXå…¬å¼
                    latexBlocks.forEach((latex, index) => {
                        const placeholder = `__LATEX_BLOCK_${index}__`;
                        rendered = rendered.replaceAll(placeholder, latex);
                        console.log(`âœ“ æ¢å¤å—çº§å…¬å¼ #${index}: ${latex.substring(0, 50)}`);
                    });

                    latexInline.forEach((latex, index) => {
                        const placeholder = `__LATEX_INLINE_${index}__`;
                        rendered = rendered.replaceAll(placeholder, latex);
                        console.log(`âœ“ æ¢å¤è¡Œå†…å…¬å¼ #${index}: ${latex.substring(0, 50)}`);
                    });

                    // ğŸ”¥ æœ€ç»ˆä¿®å¤ï¼šå¤„ç†è¢«Markdowné”™è¯¯åŒ…è£¹çš„LaTeXå…¬å¼
                    if (hasLatex) {
                        // ä¿®å¤è¢«codeæ ‡ç­¾åŒ…è£¹çš„LaTeXå…¬å¼
                        rendered = rendered.replace(/<code>(\$[^<]+?\$)<\/code>/g, '$1');
                        rendered = rendered.replace(/<code>(\$\$[^<]*?\$\$)<\/code>/g, '$1');
                        rendered = rendered.replace(/<code>(\\(?:\(|\[)[^<]*?\\(?:\)|\]))<\/code>/g, '$1');

                        console.log(`ğŸ”§ æ‰§è¡ŒLaTeXåå¤„ç†ä¿®å¤`);
                    }

                    return rendered;
                } catch (error) {
                    console.warn('âŒ Markedæ¸²æŸ“å¤±è´¥:', error);
                    return content.replace(/\n/g, '<br>');
                }
            }

            return content.replace(/\n/g, '<br>');
        }

        function testRender() {
            const input = document.getElementById('input');
            const result = document.getElementById('result');

            const content = input.value;
            console.log('ğŸ”„ å¼€å§‹æµ‹è¯•æ¸²æŸ“...');

            // æ¸²æŸ“Markdown
            const rendered = renderMarkdown(content);
            result.innerHTML = rendered;

            // æ¸²æŸ“MathJax
            setTimeout(() => {
                renderMath(result);
            }, 100);
        }

        function renderMath(element) {
            if (!element) {
                console.warn('âš ï¸ å…ƒç´ ä¸ºç©ºï¼Œæ— æ³•æ¸²æŸ“æ•°å­¦å…¬å¼');
                return;
            }

            if (typeof MathJax === 'undefined') {
                console.warn('âš ï¸ MathJax æœªåŠ è½½ï¼Œé‡è¯•ä¸­...');
                setTimeout(() => renderMath(element), 500);
                return;
            }

            const hasLatexContent = /\$[\s\S]*?\$|\\\([\s\S]*?\\\)|\\\[[\s\S]*?\\\]/.test(element.innerHTML);
            console.log('ğŸ”„ å¼€å§‹æ¸²æŸ“æ•°å­¦å…¬å¼...');
            console.log(`ğŸ“ å…ƒç´ å†…å®¹: ${element.innerHTML.substring(0, 150)}`);
            console.log(`ğŸ” æ£€æµ‹åˆ°LaTeXå†…å®¹: ${hasLatexContent}`);

            if (!hasLatexContent) {
                console.log('â„¹ï¸ æœªæ£€æµ‹åˆ°LaTeXå†…å®¹ï¼Œè·³è¿‡MathJaxæ¸²æŸ“');
                return;
            }

            // å¼ºåˆ¶æ ‡è®°å…ƒç´ ä¸ºéœ€è¦å¤„ç†çš„ç±»
            element.classList.add('tex2jax_process');
            element.classList.remove('tex2jax_ignore');

            if (MathJax.startup && MathJax.startup.promise) {
                MathJax.startup.promise.then(() => {
                    MathJax.typesetPromise([element])
                        .then(() => {
                            console.log('âœ… LaTeX æ¸²æŸ“æˆåŠŸ');
                            const mjxContainers = element.querySelectorAll('.mjx-container, [role="img"], mjx-container');
                            console.log(`MathJax å®¹å™¨æ•°é‡: ${mjxContainers.length}`);

                            if (mjxContainers.length === 0) {
                                console.warn('âš ï¸ æœªå‘ç° MathJax å®¹å™¨ï¼');
                            }
                        })
                        .catch(err => {
                            console.error('âŒ MathJax æ¸²æŸ“å¤±è´¥:', err);
                        });
                });
            }
        }

        function clearResult() {
            document.getElementById('result').innerHTML = 'ç‚¹å‡»"æµ‹è¯•æ¸²æŸ“"æŒ‰é’®æŸ¥çœ‹ç»“æœ';
        }

        function checkMathJax() {
            const diagnostics = document.getElementById('diagnostics');
            let info = '=== MathJax è¯Šæ–­ä¿¡æ¯ ===\n';
            info += `MathJax åŠ è½½: ${typeof MathJax !== 'undefined' ? 'âœ“ æ˜¯' : 'âœ— å¦'}\n`;

            if (typeof MathJax !== 'undefined') {
                info += `version: ${MathJax.version || 'unknown'}\n`;
                info += `startup: ${MathJax.startup ? 'âœ“' : 'âœ—'}\n`;
                info += `typesetPromise: ${typeof MathJax.typesetPromise === 'function' ? 'âœ“' : 'âœ—'}\n`;
                info += `startup.promise: ${MathJax.startup && MathJax.startup.promise ? 'âœ“' : 'âœ—'}\n`;
            }

            diagnostics.textContent = info;
        }

        function forceRender() {
            const result = document.getElementById('result');
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise().then(() => {
                    console.log('âœ… å…¨å±€ MathJax æ¸²æŸ“å®Œæˆ');
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkMathJax, 2000);
        });
    </script>
</body>
</html>