<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æµ‹è¯• - LLMReader Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-zone {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        .upload-zone:hover {
            background: linear-gradient(135deg, #e7f3ff, #cce7ff);
            border-color: #0056b3;
            transform: translateY(-2px);
        }
        .upload-zone.dragover {
            background: linear-gradient(135deg, #e7f3ff, #b3d9ff);
            border-color: #0056b3;
            transform: scale(1.02);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 1.1rem;
            color: #495057;
            margin: 0;
        }
        #pdf-file-input {
            display: none;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3, #003d82);
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        .status.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: linear-gradient(135deg, #f8d7da, #f1aeb5);
            color: #721c24;
            border: 1px solid #f1aeb5;
        }
        .status.info {
            background: linear-gradient(135deg, #cce7ff, #99d8ff);
            color: #004085;
            border: 1px solid #99d8ff;
        }
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
        h1 { color: #343a40; text-align: center; }
        h2 { color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
        <p style="text-align: center; color: #6c757d;">LLMReader POC UI - æ–‡ä»¶é€‰æ‹©åŠŸèƒ½è°ƒè¯•å·¥å…·</p>

        <h2>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ</h2>
        <div class="upload-zone" id="pdf-upload-zone">
            <div class="upload-icon">ğŸ“</div>
            <p class="upload-text">æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <input type="file" id="pdf-file-input" accept=".pdf">
        </div>

        <!-- å¤‡ç”¨æ–¹æ¡ˆï¼šå®Œå…¨å¯è§çš„æ–‡ä»¶è¾“å…¥ -->
        <div style="margin: 20px 0; padding: 15px; border: 2px solid #ffc107; border-radius: 8px; background: #fff3cd;">
            <h4 style="color: #856404; margin: 0 0 10px 0;">ğŸ”„ å¤‡ç”¨æ–‡ä»¶é€‰æ‹©æ–¹æ¡ˆ</h4>
            <p style="color: #856404; margin: 0 0 10px 0; font-size: 0.9rem;">å¦‚æœä¸Šæ–¹çš„ç‚¹å‡»åŒºåŸŸæ— æ³•æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„æŒ‰é’®ï¼š</p>
            <input type="file" id="backup-file-input" accept=".pdf" style="margin: 5px 0;">
        </div>

        <div class="test-buttons">
            <button id="process-pdf-btn" class="btn btn-primary" disabled>ğŸš€ å¼€å§‹å¤„ç† PDF</button>
            <button id="clear-btn" class="btn" style="background: #6c757d; color: white;">ğŸ—‘ï¸ æ¸…é™¤é€‰æ‹©</button>
            <button id="test-click-btn" class="btn" style="background: #17a2b8; color: white;">ğŸ§ª æµ‹è¯•ç‚¹å‡»</button>
        </div>

        <div id="status" class="status info">âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…æ–‡ä»¶é€‰æ‹©...</div>

        <h2>ğŸ” è°ƒè¯•æ—¥å¿—</h2>
        <div id="debug-log" class="debug-log">
            <div class="log-entry log-info">é¡µé¢åˆå§‹åŒ–ä¸­...</div>
        </div>

        <h2>ğŸŒ æµè§ˆå™¨ç¯å¢ƒä¿¡æ¯</h2>
        <div id="browser-info" class="debug-log">
            <div class="log-entry log-info">æ£€æµ‹æµè§ˆå™¨ä¿¡æ¯ä¸­...</div>
        </div>
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            const debugLog = document.getElementById('debug-log');
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;

            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            log(message, type);
        }

        log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ æµ‹è¯•é¡µé¢');

        // æµè§ˆå™¨ç¯å¢ƒæ£€æµ‹
        function detectBrowserInfo() {
            const browserInfo = document.getElementById('browser-info');
            const info = [];

            info.push(`ğŸŒ ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`);
            info.push(`ğŸ“± å¹³å°: ${navigator.platform}`);
            info.push(`ğŸ”’ åè®®: ${window.location.protocol}`);
            info.push(`ğŸ  ä¸»æœº: ${window.location.host}`);
            info.push(`ğŸ“„ é¡µé¢URL: ${window.location.href}`);

            // æ£€æµ‹æ˜¯å¦æ”¯æŒFile API
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                info.push(`âœ… File API: æ”¯æŒ`);
            } else {
                info.push(`âŒ File API: ä¸æ”¯æŒ`);
            }

            // æ£€æµ‹æ˜¯å¦æ”¯æŒDataTransfer
            try {
                new DataTransfer();
                info.push(`âœ… DataTransfer API: æ”¯æŒ`);
            } catch (e) {
                info.push(`âŒ DataTransfer API: ä¸æ”¯æŒ`);
            }

            // æ£€æµ‹å®‰å…¨ä¸Šä¸‹æ–‡
            if (window.isSecureContext) {
                info.push(`ğŸ”’ å®‰å…¨ä¸Šä¸‹æ–‡: æ˜¯`);
            } else {
                info.push(`âš ï¸ å®‰å…¨ä¸Šä¸‹æ–‡: å¦`);
            }

            // æ£€æµ‹æ˜¯å¦åœ¨iframeä¸­
            if (window.parent !== window) {
                info.push(`ğŸ–¼ï¸ iframeç¯å¢ƒ: æ˜¯`);
            } else {
                info.push(`ğŸ–¼ï¸ iframeç¯å¢ƒ: å¦`);
            }

            browserInfo.innerHTML = info.map(item =>
                `<div class="log-entry log-info">${item}</div>`
            ).join('');

            info.forEach(item => log(item));
        }

        function init() {
            log('ğŸ“‹ æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ...');
            detectBrowserInfo();

            log('ğŸ“‹ è·å–DOMå…ƒç´ ...');

            const uploadZone = document.getElementById('pdf-upload-zone');
            const fileInput = document.getElementById('pdf-file-input');
            const backupFileInput = document.getElementById('backup-file-input');
            const processPdfBtn = document.getElementById('process-pdf-btn');
            const clearBtn = document.getElementById('clear-btn');
            const testClickBtn = document.getElementById('test-click-btn');

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const elements = {
                uploadZone: !!uploadZone,
                fileInput: !!fileInput,
                backupFileInput: !!backupFileInput,
                processPdfBtn: !!processPdfBtn,
                clearBtn: !!clearBtn,
                testClickBtn: !!testClickBtn
            };

            log(`ğŸ“Š å…ƒç´ æ£€æŸ¥: ${JSON.stringify(elements)}`);

            if (!uploadZone || !fileInput || !processPdfBtn) {
                log('âŒ å…³é”®å…ƒç´ æœªæ‰¾åˆ°', 'error');
                showStatus('âŒ é¡µé¢å…ƒç´ åŠ è½½å¤±è´¥', 'error');
                return;
            }

            log('âœ… æ‰€æœ‰å…³é”®å…ƒç´ æ‰¾åˆ°ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');

            // 1. ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadZone.addEventListener('click', (e) => {
                log('ğŸ‘† ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
                log(`ğŸ“Š äº‹ä»¶è¯¦æƒ…: type=${e.type}, target=${e.target.tagName}, isTrusted=${e.isTrusted}`);

                // ä¸é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼Œè¿™å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨
                // e.preventDefault();

                try {
                    log('ğŸ”„ å‡†å¤‡è§¦å‘fileInput.click()...');

                    // æ£€æŸ¥inputå…ƒç´ çŠ¶æ€
                    log(`ğŸ“‹ Inputå…ƒç´ çŠ¶æ€: disabled=${fileInput.disabled}, style.display=${fileInput.style.display}, type=${fileInput.type}`);

                    // å°è¯•ä¸åŒçš„è§¦å‘æ–¹å¼
                    log('ğŸ§ª æ–¹æ³•1: ç›´æ¥è°ƒç”¨click()');
                    fileInput.click();

                    log('âœ… fileInput.click() è°ƒç”¨å®Œæˆ');
                    showStatus('ğŸ“ å·²è°ƒç”¨æ–‡ä»¶é€‰æ‹©æ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦å¼¹å‡ºå¯¹è¯æ¡†...', 'info');

                    // å»¶è¿Ÿæ£€æŸ¥æ˜¯å¦çœŸçš„è§¦å‘äº†æ–‡ä»¶é€‰æ‹©
                    setTimeout(() => {
                        if (fileInput.files.length === 0) {
                            log('âš ï¸ æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†å¯èƒ½æ²¡æœ‰å¼¹å‡ºï¼ˆæ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼‰', 'warning');
                            showStatus('âš ï¸ æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢', 'warning');
                        }
                    }, 1000);

                } catch (error) {
                    log(`âŒ è§¦å‘æ–‡ä»¶é€‰æ‹©å¤±è´¥: ${error.message}`, 'error');
                    showStatus('âŒ æ–‡ä»¶é€‰æ‹©è§¦å‘å¤±è´¥', 'error');
                }
            });

            // é€šç”¨æ–‡ä»¶å¤„ç†å‡½æ•°
            function handleFileSelection(file, source = 'unknown') {
                log(`ğŸ“ æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘ (æ¥æº: ${source})`);

                if (file) {
                    log(`ğŸ“„ é€‰æ‹©çš„æ–‡ä»¶: ${file.name}, ç±»å‹: ${file.type}, å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)}MB`);

                    if (file.type === 'application/pdf') {
                        showStatus(`âœ… æˆåŠŸé€‰æ‹©PDFæ–‡ä»¶: ${file.name}`, 'success');
                        processPdfBtn.disabled = false;

                        // æ›´æ–°æ˜¾ç¤º
                        const uploadText = uploadZone.querySelector('.upload-text');
                        if (uploadText) {
                            uploadText.innerHTML = `
                                âœ… å·²é€‰æ‹©: ${file.name}<br>
                                <small style="color: #6c757d;">å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)}MB</small>
                            `;
                        }

                        // åŒæ­¥åˆ°ä¸¤ä¸ªæ–‡ä»¶è¾“å…¥æ¡†
                        try {
                            const dt = new DataTransfer();
                            dt.items.add(file);

                            if (source !== 'main') {
                                fileInput.files = dt.files;
                            }
                            if (source !== 'backup') {
                                backupFileInput.files = dt.files;
                            }
                        } catch (e) {
                            log(`âš ï¸ æ–‡ä»¶åŒæ­¥å¤±è´¥: ${e.message}`, 'warning');
                        }

                    } else {
                        log(`âŒ æ–‡ä»¶ç±»å‹ä¸æ­£ç¡®: æœŸæœ› application/pdf, å®é™… ${file.type}`, 'error');
                        showStatus(`âŒ è¯·é€‰æ‹©PDFæ–‡ä»¶ (å½“å‰: ${file.type})`, 'error');
                        processPdfBtn.disabled = true;
                    }
                } else {
                    log('âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶', 'warning');
                    showStatus('âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶', 'warning');
                    processPdfBtn.disabled = true;
                }
            }

            // 2. ä¸»æ–‡ä»¶è¾“å…¥äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFileSelection(file, 'main');
            });

            // 2.5. å¤‡ç”¨æ–‡ä»¶è¾“å…¥äº‹ä»¶
            if (backupFileInput) {
                backupFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    handleFileSelection(file, 'backup');
                });
            }

            // 3. æ‹–æ‹½äº‹ä»¶
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
                log('ğŸ“‹ æ–‡ä»¶æ‹–æ‹½æ‚¬æµ®');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
                log('ğŸ“‹ æ–‡ä»¶æ‹–æ‹½ç¦»å¼€');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                log('ğŸ“‹ æ–‡ä»¶è¢«æ‹–æ‹½æ”¾ç½®');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    log(`ğŸ“„ æ‹–æ‹½æ–‡ä»¶: ${file.name}, ç±»å‹: ${file.type}`);

                    // ç›´æ¥å¤„ç†æ–‡ä»¶ï¼Œä¸éœ€è¦è®¾ç½®åˆ°inputå…ƒç´ 
                    handleFileSelection(file, 'drag');
                }
            });

            // 4. å¤„ç†æŒ‰é’®
            processPdfBtn.addEventListener('click', () => {
                log('ğŸš€ å¤„ç†PDFæŒ‰é’®è¢«ç‚¹å‡»');
                const file = fileInput.files[0];
                if (file) {
                    showStatus(`ğŸš€ å¼€å§‹å¤„ç†æ–‡ä»¶: ${file.name}`, 'success');
                } else {
                    showStatus('âŒ æ²¡æœ‰æ–‡ä»¶å¯å¤„ç†', 'error');
                }
            });

            // 5. æ¸…é™¤æŒ‰é’®
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    log('ğŸ—‘ï¸ æ¸…é™¤æ–‡ä»¶é€‰æ‹©');
                    fileInput.value = '';
                    if (backupFileInput) {
                        backupFileInput.value = '';
                    }
                    processPdfBtn.disabled = true;

                    const uploadText = uploadZone.querySelector('.upload-text');
                    if (uploadText) {
                        uploadText.textContent = 'æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶';
                    }

                    showStatus('ğŸ—‘ï¸ å·²æ¸…é™¤æ–‡ä»¶é€‰æ‹©', 'info');
                });
            }

            // 6. æµ‹è¯•ç‚¹å‡»æŒ‰é’®
            if (testClickBtn) {
                testClickBtn.addEventListener('click', () => {
                    log('ğŸ§ª æµ‹è¯•æŒ‰é’®ç‚¹å‡» - å°è¯•å¤šç§æ–¹æ³•è§¦å‘æ–‡ä»¶é€‰æ‹©');

                    try {
                        log('ğŸ§ª æ–¹æ³•1: ç›´æ¥è°ƒç”¨fileInput.click()');
                        fileInput.click();
                        log('âœ… æ–¹æ³•1è°ƒç”¨å®Œæˆ');

                        setTimeout(() => {
                            log('ğŸ§ª æ–¹æ³•2: åˆ›å»ºå¹¶è§¦å‘ç‚¹å‡»äº‹ä»¶');
                            try {
                                const clickEvent = new MouseEvent('click', {
                                    bubbles: true,
                                    cancelable: true,
                                    view: window
                                });
                                fileInput.dispatchEvent(clickEvent);
                                log('âœ… æ–¹æ³•2è°ƒç”¨å®Œæˆ');
                            } catch (e) {
                                log(`âŒ æ–¹æ³•2å¤±è´¥: ${e.message}`, 'error');
                            }

                            setTimeout(() => {
                                log('ğŸ§ª æ–¹æ³•3: å°è¯•èšç„¦åè§¦å‘');
                                try {
                                    fileInput.focus();
                                    fileInput.click();
                                    log('âœ… æ–¹æ³•3è°ƒç”¨å®Œæˆ');
                                } catch (e) {
                                    log(`âŒ æ–¹æ³•3å¤±è´¥: ${e.message}`, 'error');
                                }

                                setTimeout(() => {
                                    log('ğŸ§ª æ–¹æ³•4: ç§»é™¤display:noneåè§¦å‘');
                                    try {
                                        const originalDisplay = fileInput.style.display;
                                        fileInput.style.display = 'block';
                                        fileInput.style.position = 'absolute';
                                        fileInput.style.left = '-9999px';
                                        fileInput.click();
                                        fileInput.style.display = originalDisplay;
                                        fileInput.style.position = '';
                                        fileInput.style.left = '';
                                        log('âœ… æ–¹æ³•4è°ƒç”¨å®Œæˆ');
                                    } catch (e) {
                                        log(`âŒ æ–¹æ³•4å¤±è´¥: ${e.message}`, 'error');
                                    }
                                }, 500);
                            }, 500);
                        }, 500);

                    } catch (error) {
                        log(`âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥: ${error.message}`, 'error');
                    }
                });
            }

            log('âœ… æ‰€æœ‰äº‹ä»¶ç»‘å®šå®Œæˆ');
            showStatus('âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å·²å°±ç»ªï¼Œè¯·ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                log('ğŸ“„ DOMå†…å®¹åŠ è½½å®Œæˆ');
                init();
            });
        } else {
            log('ğŸ“„ DOMå·²ç»åŠ è½½å®Œæˆ');
            init();
        }

        // é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶
        window.addEventListener('load', () => {
            log('ğŸŒ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>