<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ LaTeX èŠå¤©æ¸²æŸ“è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .control-panel {
            width: 300px;
            border-right: 1px solid #eee;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .control-panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #555;
        }
        
        .control-group textarea {
            width: 100%;
            height: 100px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            width: 100%;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .test-buttons {
            display: grid;
            gap: 0.5rem;
        }
        
        .test-btn {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: white;
        }
        
        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            max-width: 100%;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.25rem;
        }
        
        .message-content {
            max-width: 70%;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
        }
        
        .message.assistant .message-content {
            background: #f0f0f0;
            border: 1px solid #ddd;
        }
        
        .status {
            background: #e8f4f8;
            padding: 1rem;
            margin: 0.5rem 1.5rem;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #333;
            font-family: monospace;
        }
        
        .status.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .input-area {
            border-top: 1px solid #eee;
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        
        .input-area textarea {
            flex: 1;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 60px;
            max-height: 120px;
        }
        
        .input-area button {
            width: auto;
            padding: 1rem 2rem;
        }
        
        .debug-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
            font-family: monospace;
        }
        
        .mjx-container {
            display: inline-block;
            margin: 0 0.25em;
        }
        
        .mjx-container[display="true"] {
            display: block;
            text-align: center;
            margin: 0.5em 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ LaTeX èŠå¤©æ¸²æŸ“è¯Šæ–­å·¥å…·</h1>
            <p>æµ‹è¯•èŠå¤©æ¨¡å¼ä¸­çš„ LaTeX å…¬å¼æ¸²æŸ“</p>
        </div>
        
        <div class="content">
            <div class="control-panel">
                <h3>ğŸ“‹ å¿«é€Ÿæµ‹è¯•</h3>
                <div class="control-group">
                    <label>è‡ªå®šä¹‰æ¶ˆæ¯:</label>
                    <textarea id="customMessage" placeholder="è¾“å…¥åŒ…å« LaTeX çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
è¿™æ˜¯è¡Œå†…å…¬å¼ $E=mc^2$ å’Œå—çº§å…¬å¼
$$\frac{a}{b}$$"></textarea>
                </div>
                
                <div class="test-buttons">
                    <button class="test-btn" onclick="sendTest('custom')">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>
                    <button class="test-btn" onclick="sendTest('inline')">è¡Œå†…å…¬å¼æµ‹è¯•</button>
                    <button class="test-btn" onclick="sendTest('display')">å—çº§å…¬å¼æµ‹è¯•</button>
                    <button class="test-btn" onclick="sendTest('mixed')">æ··åˆå†…å®¹æµ‹è¯•</button>
                    <button class="test-btn" onclick="sendTest('complex')">å¤æ‚å…¬å¼æµ‹è¯•</button>
                </div>
                
                <h3 style="margin-top: 2rem;">ğŸ”§ å·¥å…·</h3>
                <div class="test-buttons">
                    <button class="test-btn" onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
                    <button class="test-btn" onclick="checkMathJax()">æ£€æŸ¥ MathJax</button>
                    <button class="test-btn" onclick="dumpDebugInfo()">å¯¼å‡ºè°ƒè¯•ä¿¡æ¯</button>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="messages" id="messages"></div>
                
                <div class="input-area">
                    <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                    <button onclick="sendCustom()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MathJax é…ç½® (ä¸ chat.html ä¸€è‡´) -->
    <script type="text/javascript">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'newcommand', 'configmacros']},
                tags: 'ams',
                tagSide: 'right',
                tagIndent: '.8em',
                multlineWidth: '85%',
                autoload: {
                    color: [],
                    colorV2: ['color']
                }
            },
            chtml: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false,
                fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
            },
            svg: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false,
                fontCache: 'global'
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            startup: {
                ready: function () {
                    MathJax.startup.defaultReady();
                    console.log('âœ“ MathJax å·²åˆå§‹åŒ–');
                    addStatus('âœ… MathJax å·²åˆå§‹åŒ–', 'success');
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    
    <script>
        const testMessages = {
            inline: 'è¿™æ˜¯ä¸€ä¸ªè¡Œå†…å…¬å¼æµ‹è¯•ï¼š$E=mc^2$ å’Œå¦ä¸€ä¸ª $\\sin(x) = \\cos(x + \\pi/2)$',
            display: 'è¿™æ˜¯ä¸€ä¸ªå—çº§å…¬å¼æµ‹è¯•ï¼š\n$$a^2 + b^2 = c^2$$\n\nä¸‹é¢è¿˜æœ‰ä¸€ä¸ªï¼š\n$$\\frac{1}{2} \\int_0^\\pi \\sin(x) dx$$',
            mixed: '## æµ‹è¯•æ ‡é¢˜\n\nè¿™æ˜¯æ®µè½ä¸­çš„è¡Œå†…å…¬å¼ï¼š$E=mc^2$ã€‚\n\nä¸‹é¢æ˜¯å—çº§å…¬å¼ï¼š\n$$\\nabla \\cdot \\vec{E} = \\frac{\\rho}{\\epsilon_0}$$\n\næœ€åæ˜¯ `code` ç¤ºä¾‹ã€‚',
            complex: '### é«˜ç­‰æ•°å­¦å…¬å¼\n\n**å‚…é‡Œå¶çº§æ•°**ï¼š\n$$f(x) = \\frac{a_0}{2} + \\sum_{n=1}^{\\infty} \\left( a_n \\cos(nx) + b_n \\sin(nx) \\right)$$\n\nå…¶ä¸­ $a_n = \\frac{1}{\\pi}\\int_{-\\pi}^{\\pi} f(x)\\cos(nx)dx$'
        };
        
        function sendTest(type) {
            const message = testMessages[type] || '';
            if (message) {
                addMessage('user', message);
                setTimeout(() => {
                    addMessage('assistant', `è¿™æ˜¯å¯¹ ${type} æµ‹è¯•çš„å“åº”ã€‚æˆ‘å‘é€äº†åŒ…å« LaTeX å…¬å¼çš„æ¶ˆæ¯ã€‚`);
                }, 500);
            }
        }
        
        function sendCustom() {
            const input = document.getElementById('input');
            if (input.value.trim()) {
                addMessage('user', input.value);
                input.value = '';
            }
        }
        
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // æ·»åŠ å¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content tex2jax_process';
            contentDiv.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            addStatus(`âœ“ æ·»åŠ äº†æ¶ˆæ¯ (${role}), é•¿åº¦: ${content.length}`, 'success');
            
            // æ¸²æŸ“ MathJax
            renderMath(contentDiv);
        }
        
        function renderMath(element) {
            if (!element) {
                console.warn('å…ƒç´ ä¸ºç©º');
                return;
            }
            
            if (typeof MathJax === 'undefined') {
                console.warn('MathJax æœªåŠ è½½');
                setTimeout(() => renderMath(element), 500);
                return;
            }
            
            console.log('ğŸ”„ å¼€å§‹æ¸²æŸ“ LaTeX...');
            addStatus('ğŸ”„ è°ƒç”¨ MathJax.typesetPromise()...', 'success');
            
            if (MathJax.startup && MathJax.startup.promise) {
                MathJax.startup.promise.then(() => {
                    console.log('âœ“ MathJax å·²å‡†å¤‡');
                    MathJax.typesetPromise([element])
                        .then(() => {
                            console.log('âœ… LaTeX æ¸²æŸ“æˆåŠŸ');
                            addStatus('âœ… LaTeX æ¸²æŸ“æˆåŠŸ', 'success');
                        })
                        .catch(err => {
                            console.error('âŒ æ¸²æŸ“å¤±è´¥:', err);
                            addStatus('âŒ æ¸²æŸ“å¤±è´¥: ' + err, 'error');
                        });
                }).catch(err => {
                    console.warn('âš ï¸ æ‰¿è¯ºå¤±è´¥:', err);
                    addStatus('âš ï¸ æ‰¿è¯ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ¸²æŸ“', 'error');
                    MathJax.typesetPromise([element]);
                });
            } else {
                console.log('ç›´æ¥è°ƒç”¨ typesetPromise');
                MathJax.typesetPromise([element]);
            }
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            addStatus('âœ“ æ¶ˆæ¯å·²æ¸…ç©º', 'success');
        }
        
        function addStatus(message, type = 'success') {
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            document.getElementById('messages').appendChild(status);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
        
        function checkMathJax() {
            addStatus('=== MathJax æ£€æŸ¥ ===', 'success');
            addStatus(`MathJax åŠ è½½: ${typeof MathJax !== 'undefined' ? 'âœ“ æ˜¯' : 'âœ— å¦'}`, 'success');
            
            if (typeof MathJax !== 'undefined') {
                addStatus(`startup: ${MathJax.startup ? 'âœ“' : 'âœ—'}`, 'success');
                addStatus(`typesetPromise: ${typeof MathJax.typesetPromise === 'function' ? 'âœ“' : 'âœ—'}`, 'success');
                addStatus(`startup.promise: ${MathJax.startup && MathJax.startup.promise ? 'âœ“' : 'âœ—'}`, 'success');
                console.log('MathJax å¯¹è±¡:', MathJax);
            }
        }
        
        function dumpDebugInfo() {
            const info = {
                timestamp: new Date().toISOString(),
                mathJaxLoaded: typeof MathJax !== 'undefined',
                mathjaxVersion: MathJax ? MathJax.version : 'unknown',
                messageCount: document.querySelectorAll('.message').length,
                userAgent: navigator.userAgent
            };
            
            const json = JSON.stringify(info, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addStatus('âœ“ è°ƒè¯•ä¿¡æ¯å·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addStatus('âœ“ è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            setTimeout(checkMathJax, 2000);
        });
    </script>
</body>
</html>
